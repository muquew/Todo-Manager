<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Task Tracer</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4b6cb7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAACXBIWXMAAA7EAAAOxAGVKw4bAAABW0lEQVRYhe2XO46DMBRFr4cA4iNCS5NdsBHWw07YAhJbSEdBQUOXgia0FCgg/kwFgkxG4yEMpphbvQeW77GNjR/BC5mmObx6voWCICDzfJH8pfF3IBPAnuZzCMLKfNQHK+NRhOXogQPMwImmESEEmqahLEu0bYuu676853kePM9DkiTIsgxN0xBF0TYAAOB5HlRVpW2O+/0Oy7J+bEe1BMMwIAxDavMRgEbUM+C6Lq7XK5IkQZZlUBQFjuMAAG63G2zbhiAIOJ/PMAwDRVFsC+D7/iKfL0eapojjmLarhVbvgrqup/jxeKztZj3AfCfkec4WoGma/QHmYg7wfDDtDtD3PVsAjuPYApxO1MfJdgDzUQuCsD+AJElTLMvy/gC6rk+xoij7A1wuFwBA27ZvfQOrr2SiKEIURWRZttoc+MXf8FlVVaGqqrfMgQPcCZkD/Bcmx6gNWUCM1fEnwG53AxCePfgAAAAASUVORK5CYII=">
    <link rel="shortcut icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAFo9M/3AAAApklEQVR4nLRRwQnEIBBMUwpBkQR8+NQKfAgWYTNWYD2KzeydQg4OY4Lmbh6yrMPs7syyvIEQgvoU1OLT+SqaBqX0goExvmFcNm4JBc8IzYjDjeHPZsS6rnCYsO/7+Q7WWpBS9pfUWsO2bX1CUeCc9wmEkHsnp04dyuonAt57iDFCzrlmW+qUEoQQxjYwxlQBIcTcCSWXAsbYnIBzrgoopf5o4tMYXwAAAP//XH15egAAAAZJREFUAwD7tLYKdxhMJAAAAABJRU5ErkJggg==" />
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAH70lEQVR4nO3dS1ITXxvH8V+TKySEcKlQ4gQHVulYWQE7cgMuwW24BmfKSIJV6oQqGDhRM0i4J1xCSN7BW8kfueZ0nqaT099PVSqKafqUfn3qkDQhUIzW1tZ6cZ4f0alWq0Ec533SkxJwcj1V4JGfhIhxU5RxR/aJCRmPiSJs809IyHBlGbbZJyJkjMoi7JE/ASHD2ihhjxQ0MSMqYaMOHTQxI2phog4VNDHjqbhG7Rw0MeOpuUTtFDQxIy7DRj100MSMuA0T9VBBEzPGxWNRPxo0MWPcPBT1g0ETM8bVfVHfGzQxY9zdFfVUHAsBonLnhGY6Y1LcnNJMaHjl1oRmOmPSXJ/STGh45Z8JzXTGpOpPaSY0vDKY0ExnTLpqtRowoeEVgoZXAontBvzBhIZXCBpeIWh4JWD/DJ8woeEVgoZXCBpeIWh4haDhFYKGVwgaXiFoeIWg4RWChlcIGl4haHiFoOEVgoZX0nEvANHLZrMqlUpaWFjQ4uKi5ufn9evXL21vb8e9NHPeBl0oFPTu3TudnJyo2WyqVWrp9PRU5+fng1u73dbFxYU6nY4uLy8Ht6urq8F9r9dTp9NRr9dTt9v9534YQfDfe/mkUilNTU0pCAKl02kFQTD4WCaTUSqV+uc+nU4rk8kol8spm80qm80ql8spn88Pbv3fz8zMqFAoDG7FYlGlUkmlUkm5XO7Wut6/f0/Qk6TVaunNmzdaWVmJeylj6c+fP3EvIRJe76E3NzfjXsLYIugJRNB3Oz8/197eXtzLiIT3QXe73biXMXZ8nc6S50EfHx9rd3c37mWMnd+/f8e9hMh4HbTEtuMuTOgJ9vXr17iXMHYIeoJ9//5dFxcXcS9jrLDlmGDtdls/f/6MexljhQk94dhH/6fb7erv379xLyMyBJ0w9XpdnU4n7mVEJhFBb29v6+joKO5ljAWf98+Sx9dy3LS1taX19fU7/6zRaKhWq6lWq6nRaOjg4ED7+/uDi5r69+12W+12W5eXl7q4uFCv19PV1dXgYqVPnz6pXC47r+3Dhw/6+PHj4MKlqakppVKpwcVI/QuUisWipqenVSgUNDs7q3K5PLhVKhVVKhUtLy8rn8/fey6f989SgoLe3NzU+vq6jo6OtLW1pW/fvmlnZ0e7u7s6OzszOUe9Xg8V9OHh4eA/x3Vh17W0tKTV1VWtrq7q1atXev36tV68eKF0Ok3QvtjY2NDe3p42NjaGvvTT1d7enl6+fOl8nPV2qNFoqNFoaGtra/CxQqGgt2/fqlarmZ5r3CQm6EajoS9fvkR6jnq9Huq4w8ND45Xc1mq19Pnz58jPE7dEfFH4VMJewcYXrHYI2tA4T+ikIGhDjUbD+ZhOp6NWqxXBapKJoA2F2TocHx9HsJLkImhDzWbT+RiCtkXQhsJM6JOTkwhWklwEbSjMtD09PY1gJclF0IbOzs6cL/zhC0JbBG3MdUoTtC2CNua6J7a6jgT/R9DGzs/PnR4f5pkR3I+gjbkGzYS2RdDGXINmD22LoI25Bs3TdrYI2pjrWya02+2IVpJMBG3MdUITtC2CNuYaNG+CY4ugjbm+UsiEtkXQxly/X5EJbYugjd38zu3HMKFtEbQxthzxImhjbDniRdDG2HLEi6CNuf5MF34GjC2CNpZKpZwe7zrR8TCCNuYadFRvS5ZUBG0snXZ7dzW2HLYI2hhBx4ugjbkGzR7aFkEbYw8dL4I2lslknB7PlsMWQRtjQseLoI25Bg1bBG3MdcsBWwRtjAkdL4I25jqhgyCIaCXJRNDGpqen415CohG0sUKh4PT4qSn+CSzxt2nMNWj23LYI2lixWHR6PEHbImhjrntogrZF0IZSqZRyuZzzMbBD0IZc98+S+9V5eBhBGyLo+BG0oTBB81K5LYI2RNDxI2hDYYLOZrMRrCS5CNrQzMyM8zGuz4rgYQRtqFwuOx+Tz+cjWElyEbQhgo4fQRsKEzRbDlsEbYgJHT+CNjQ3N+d8DEHbImhDYYJ2vToPDyNoQ4uLi87H8B0utgja0Pz8vPMxYZ67xv0I2sjc3FyoC43CvLqI+xG0kTDbDUkqlUrGK0k2gjaytLQU6rjZ2VnjlSQbQRsJO6EJ2hZBG6lUKqGOY8thi6CNhA06zKuLuB9BGwkbdCaT4bloQwRtZHl5OfSxCwsLhitJNoI2EnZCS+FeMsfdCNpANpsdacqGfcoPtxG0gWfPno10PEHbIWgDKysrIx0f9jls3Ma7nBh4/vz50I9tNps6ODjQ/v6+Dg8PdXBwoJ2dnQhXlywEbSCbzerHjx+3Qu3fX/8YP2gzWsHa2ho/VwzeYA8NrxA0vELQ8ApBwysEDa8QNLxC0PAKQcMrBA2vEDS8QtDwCkHDKwQNrxA0vELQ8EogSVwTDV8woeEVgoZXCBpeCfq/YB+NSVetVgMmNLxC0PBKcP03bDswqarVaiAxoeGZ4OYHmNKYNP3pLDGh4ZlbE1piSmNyXJ/OEhManrlzQktMaYy/m9NZYkLDM/dOaIkpjfF113SWHglaImqMn/tiloYIWiJqjI+HYpaGDFoiasTvsZglh6AlokZ8holZcgxaImo8vWFjlkIELRE1no5LzFLIoCWiRvRcY5ZGCFoiakQnTMzSiEFLRA17YWOWDILuI2yMapSQ+8yC7iNsuLIIuc886D7CxmMsQ+6LLOg+wsZNUYTcF3nQ1xF3ckUZ8XX/AyGwyUmxQbNBAAAAAElFTkSuQmCC">
    <style>
        /* === 1. 全局变量定义 (Design Tokens) === */
        :root {
            /* 品牌色 & 状态色 */
            --color-primary: #4b6cb7;
            --color-primary-dark: #3a5aa0;
            --color-secondary: #182848;
            --color-success: #4CAF50;
            --color-success-dark: #388E3C;
            --color-warning: #FFC107;
            --color-danger: #F44336;
            --color-danger-light: rgba(244, 67, 54, 0.1);
            --color-info-light: rgba(75, 108, 183, 0.1);
            --color-success-light: rgba(76, 175, 80, 0.1);

            /* 背景色 (Backgrounds) */
            --bg-gradient-start: #f5f7fa;
            --bg-gradient-end: #c3cfe2;
            --bg-surface: #ffffff;       /* 卡片、弹窗背景 */
            --bg-surface-alt: #f9f9f9;   /* 完成任务、空状态背景 */
            --bg-hover: #f0f0f0;         /* 按钮悬停 */
            --bg-active: #e0e0e0;        /* 按钮激活 */
            --bg-overlay: rgba(0, 0, 0, 0.5); /* 弹窗遮罩 */

            /* 文本色 (Typography) */
            --text-main: #333333;        /* 主要文字 */
            --text-secondary: #666666;   /* 次要信息 */
            --text-tertiary: #999999;    /* 辅助信息 */
            --text-inverse: #ffffff;     /* 反白文字 */

            /* 边框与装饰 (Borders & Decor) */
            --border-base: #dddddd;
            --border-light: #eeeeee;
            --shadow-base: rgba(0, 0, 0, 0.1);
            --shadow-float: rgba(0, 0, 0, 0.15);
            --shadow-heavy: rgba(0, 0, 0, 0.2);
        }

        /* === 2. 深色模式变量 (手动切换支持) === */
        html[data-theme="dark"] {
            /* --- 背景：放弃高饱和渐变，使用沉稳的深灰色 --- */
            --bg-gradient-start: #18181b;  /* Zinc 900 */
            --bg-gradient-end: #18181b;    /* 纯色背景更显干净，或者用极微弱的渐变 */

            /* --- 表面：比背景稍亮，形成层级 --- */
            --bg-surface: #27272a;         /* Zinc 800 - 卡片背景 */
            --bg-surface-alt: #1f1f22;     /* 稍暗的区域 */

            /* --- 交互：明显的悬停色 --- */
            --bg-hover: #3f3f46;           /* Zinc 700 */
            --bg-active: #52525b;          /* Zinc 600 */
            --bg-overlay: rgba(0, 0, 0, 0.7); /* 遮罩 */

            /* --- 文字：降低纯白刺眼感，使用“灰白” --- */
            --text-main: #e4e4e7;          /* Zinc 200 (主要文字) */
            --text-secondary: #a1a1aa;     /* Zinc 400 (次要文字) */
            --text-tertiary: #71717a;      /* Zinc 500 (辅助文字) */
            --text-inverse: #ffffff;       /* 反白文字 */

            /* --- 边框：在深色模式下，边框比阴影更重要 --- */
            --border-base: #3f3f46;        /* Zinc 700 - 明显的分割线 */
            --border-light: #52525b;       /* Zinc 600 */

            /* --- 阴影：加深阴影以在深灰底上显形 --- */
            --shadow-base: 0 1px 3px 0 rgba(0, 0, 0, 0.5);
            --shadow-float: 0 10px 15px -3px rgba(0, 0, 0, 0.7);
            --shadow-heavy: 0 20px 25px -5px rgba(0, 0, 0, 0.9);

            /* --- 状态色：去饱和，变柔和 --- */
            /* 主色：从深蓝变成柔和的靛蓝 */
            --color-primary: #818cf8;      /* Indigo 400 */
            --color-primary-dark: #6366f1; /* Indigo 500 */

            /* 状态色：避免荧光色，使用 Pastel (粉彩) 色系 */
            --color-success: #34d399;      /* Emerald 400 (柔和绿) */
            --color-warning: #fbbf24;      /* Amber 400 (柔和黄) */
            --color-danger: #f87171;       /* Red 400 (柔和红) */

            /* 背景色微调：增加透明度，让背景色透出来 */
            --color-danger-light: rgba(248, 113, 113, 0.15);
            --color-info-light: rgba(129, 140, 248, 0.15);
            --color-success-light: rgba(52, 211, 153, 0.15);
        }

        /* 图片在暗色模式下降低亮度 */
        html[data-theme="dark"] img,
        html[data-theme="dark"] svg { opacity: 0.9; }

        /* === 3. 太阳/月亮 图标切换逻辑 === */
        .sun-icon { display: none; }
        .moon-icon { display: block; }
        html[data-theme="dark"] .sun-icon { display: block; }
        html[data-theme="dark"] .moon-icon { display: none; }

        /* 深色模式专属优化：给卡片加 1px 亮边框，提升轮廓感 */
        html[data-theme="dark"] .container,
        html[data-theme="dark"] .task-item,
        html[data-theme="dark"] .modal-content,
        html[data-theme="dark"] .menu {
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* 让输入框在深色模式下更明显 */
        html[data-theme="dark"] input,
        html[data-theme="dark"] textarea {
            background-color: #18181b; /* 比卡片更深，形成凹陷感 */
            border-color: var(--border-base);
        }

        html[data-theme="dark"] input:focus,
        html[data-theme="dark"] textarea:focus {
            border-color: var(--color-primary);
            background-color: #18181b;
        }
        /* === 基本设置 === */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-main);

            transition: background 0.3s ease, color 0.3s ease;
        }

        .container, .task-item, .modal-content, input, textarea, .menu {
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--bg-surface);
            border-radius: 12px;
            box-shadow: 0 10px 30px var(--shadow-base);
            overflow: hidden;
            position: relative;
        }

        /* === 可访问性 (A11y) 样式 ===
         用于隐藏元素，但保持屏幕阅读器可读
        */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* === Header === */
        header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: var(--text-inverse);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        h1 { font-size: 22px; font-weight: 600; }
        .subtitle { font-size: 14px; opacity: 0.8; line-height: 1.3; }

        html[lang="en"] h1 { font-size: 24px; }

        .header-actions { display: flex; gap: 10px; align-items: center; }

        .icon-btn, .lang-btn {
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-inverse);
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
        }

        .icon-btn { background: var(--color-primary); font-weight: 600; }
        .icon-btn:hover {
            background: var(--color-primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-base);
        }

        /* === Menu === */
        .menu {
            display: none; /* 初始状态 */
            position: absolute;
            top: 55px; /* 调整到 Header 区域下方 */
            right: 15px;
            background: var(--bg-surface);
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow-float);
            z-index: 500;
            min-width: 100px;
            padding: 8px 0;
        }
        .menu.show { display: block; }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 10px 15px;
            border: none;
            background: none;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-main);
        }
        .menu-item:hover { background: var(--bg-hover); }
        .menu-item svg { width: 16px; height: 16px; color: var(--color-primary); fill: none; }

        .menu-divider { height: 1px; background: var(--border-light); margin: 8px 0; }

        .submenu {
            display: none;
            background: var(--bg-surface-alt); /* 轻微的背景色以便区分 */
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease-out;
        }
        .submenu.show {
            display: block;
            max-height: 200px; /* 或者一个足够的高度 */
        }
        .submenu .lang-btn { padding-left: 41px; color: var(--text-main); background: none; width: 100%; text-align: left; border-radius: 0; font-weight: normal; }
        .submenu .lang-btn:hover { background: var(--bg-hover); }
        .submenu .lang-btn.active { background: var(--bg-active); font-weight: bold; }

        #langMenuToggle.open svg:last-child { transform: rotate(90deg); }

        /* === Main Content === */
        .main-content { padding: 20px; }
        .search-box {
            margin-bottom: 15px;
            position: relative; /* 关键：让内部的绝对定位元素以我为基准 */
            display: flex;      /* 确保高度正常 */
            align-items: center;
        }

        .search-input {
            width: 100%;
            padding: 10px 12px;
            /* 关键：右侧留出 45px 空间，防止文字被快捷键提示挡住 */
            padding-right: 45px;
            border: 1px solid var(--border-base);
            border-radius: 6px;
            font-size: 14px;
            background: var(--bg-surface);
            color: var(--text-main);
        }

        .filters { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; }

        .filter-btn {
            background: var(--bg-hover);
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-main);
        }
        .filter-btn.active { background: var(--color-primary); color: var(--text-inverse); }
        .filter-btn:hover { background: var(--bg-active); }
        .filter-btn.active:hover { background: var(--color-primary-dark); }

        /* === Tasks (Using Scoped Variables) === */
        .tasks-section { margin-bottom: 25px; }

        .task-item {
            --task-color: var(--color-primary); /* 默认颜色 */
            background: var(--bg-surface);
            border-left: 5px solid var(--task-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 3px 10px var(--shadow-base);
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }

        /* 状态颜色映射 */
        .task-item.status-safe { --task-color: var(--color-success); }
        .task-item.status-warning { --task-color: var(--color-warning); }
        .task-item.status-danger { --task-color: var(--color-danger); }
        .task-item.status-no-deadline { --task-color: var(--text-tertiary); }
        .task-item.completed { --task-color: var(--color-success); background-color: var(--bg-surface-alt); opacity: 0.8; }
        .completed-task .task-name .task-title { text-decoration: line-through; color: var(--text-tertiary); }

        .task-item:hover { transform: translateY(-2px); box-shadow: 0 5px 15px var(--shadow-base); }

        .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .task-title { font-size: 16px; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 8px; word-break: break-all; }

        .task-date {
            font-size: 12px;
            color: var(--text-secondary);
            background: var(--bg-hover);
            padding: 3px 8px;
            border-radius: 15px;
            white-space: nowrap;
        }

        .task-desc { color: var(--text-secondary); margin-bottom: 10px; line-height: 1.4; font-size: 14px; word-break: break-word; }
        .task-footer { display: flex; justify-content: space-between; align-items: center; }
        .status-indicator { display: flex; align-items: center; font-size: 13px; font-weight: 500; color: var(--text-main); }

        .status-dot {
            width: 10px; height: 10px; border-radius: 50%; margin-right: 6px;
            background-color: var(--task-color); /* 自动应用状态色 */
        }

        .status-time-left { margin-left: 5px; color: var(--text-secondary); }

        /* Actions */
        .task-actions { display: flex; gap: 8px; }
        .action-btn {
            background: none; border: none; cursor: pointer; font-size: 16px;
            transition: color 0.2s; padding: 5px; border-radius: 4px;
            display: flex; align-items: center; justify-content: center;
        }

        .edit-btn { color: var(--color-primary); }
        .edit-btn:hover { color: var(--color-primary-dark); background: var(--color-info-light); }

        .delete-btn { color: var(--text-tertiary); }
        .delete-btn:hover { color: var(--color-danger); background: var(--color-danger-light); }

        .complete-btn { color: var(--color-success); }
        .complete-btn:hover { color: var(--color-success-dark); background: var(--color-success-light); }

        /* Loading & Empty States */
        .loading-state { text-align: center; padding: 40px 20px; color: var(--text-tertiary); }
        .loading-state .spinner {
            width: 40px; height: 40px; border: 4px solid var(--bg-hover);
            border-top-color: var(--color-primary); border-radius: 50%;
            margin: 0 auto 15px auto; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .empty-state {
            text-align: center; padding: 30px 20px;
            color: var(--text-tertiary); background: var(--bg-surface-alt);
            border-radius: 8px; border: 2px dashed var(--border-base);
        }
        .empty-state svg { margin-bottom: 15px; opacity: 0.6; }
        .empty-state h3 { font-size: 16px; margin-bottom: 8px; color: var(--text-secondary); }
        .empty-state p { font-size: 14px; }

        .progress-bar {
            height: 5px; background: var(--bg-hover);
            border-radius: 3px; margin-top: 8px; overflow: hidden; margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%; border-radius: 3px; transition: width 0.5s ease;
            background-color: var(--task-color); /* 自动应用状态色 */
        }

        .task-item.animate-complete { animation: completeAnimation 0.5s ease; }
        @keyframes completeAnimation {
            0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); }
        }

        /* === Modal === */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-overlay); z-index: 1000;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: var(--bg-surface); border-radius: 12px;
            width: 90%; max-width: 500px; box-shadow: 0 10px 30px var(--shadow-heavy);
            animation: modalAppear 0.3s ease;
        }
        @keyframes modalAppear { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        .modal-header {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            color: var(--text-inverse); padding: 15px 20px; border-radius: 12px 12px 0 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-title { font-size: 18px; font-weight: 600; }
        .close-btn {
            background: none; border: none; color: var(--text-inverse); font-size: 20px;
            cursor: pointer; width: 30px; height: 30px; display: flex; align-items: center;
            justify-content: center; border-radius: 50%; transition: background 0.2s;
        }
        .close-btn:hover { background: rgba(255, 255, 255, 0.2); }

        .modal-body { padding: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-main); }

        input, textarea {
            width: 100%; padding: 10px 12px; border: 1px solid var(--border-base);
            border-radius: 6px; font-size: 14px; transition: border 0.3s;
            background: var(--bg-surface); color: var(--text-main);
        }
        input:focus, textarea:focus {
            border-color: var(--color-primary); outline: none;
            box-shadow: 0 0 0 2px var(--color-info-light);
        }
        textarea { min-height: 70px; resize: vertical; }

        .datetime-group { display: flex; gap: 10px; align-items: center; }
        .date-input, .time-input { flex: 1; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
        .checkbox-group input[type="checkbox"] { width: auto; }

        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn { padding: 10px 20px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; border: none; }
        .btn-primary { background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%); color: var(--text-inverse); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px var(--shadow-base); }
        .btn-secondary { background: var(--bg-hover); color: var(--text-main); }
        .btn-secondary:hover { background: var(--bg-active); }

        /* === Misc === */
        .file-input { display: none; }
        .notification {
            position: fixed; top: 20px; right: 20px;
            background: var(--color-success); color: var(--text-inverse);
            padding: 12px 20px; border-radius: 6px;
            box-shadow: 0 4px 12px var(--shadow-float);
            z-index: 1001; display: flex; align-items: center; gap: 8px;
            transform: translateX(150%); transition: transform 0.3s ease;
        }
        .notification.show { transform: translateX(0); }
        .notification.error { background: var(--color-danger); }
        .notification.warning { background: var(--color-warning); color: var(--text-main); }

        .svg-no-fill { fill: none; }
        #lang-container { display: contents; }

        /* === Responsive === */
        @media (max-width: 600px) {
            .container { border-radius: 8px; }
            .main-content { padding: 15px; }
            .task-header { flex-direction: column; align-items: flex-start; }
            .task-date { margin-top: 5px; }
            .modal-content { width: 95%; }
            .datetime-group { flex-direction: column; gap: 8px; }
            header { padding: 15px 20px; flex-direction: row; align-items: flex-start; }
            .header-actions { display: flex; flex-direction: row; gap: 3px; align-items: flex-end; }
            .icon-btn { font-size: 10px; padding: 6px 10px; }
            .filters { flex-direction: row; gap: 10px; }
            .filter-btn { padding: 6px 6px; font-size: 12px; }
            .task-actions { flex-direction: row; }
        }

        /* 快捷键提示样式 */
        .shortcut-hint {
            display: none; /* 默认移动端隐藏 */
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%); /* 垂直居中 */
            z-index: 2; /* 确保浮在 input 上面 */
            pointer-events: none; /* 鼠标穿透，不影响点击输入框 */
            color: var(--text-tertiary);
            font-size: 12px;
        }

        .shortcut-kbd {
            font-family: monospace;
            border: 1px solid var(--border-base);
            border-radius: 4px;
            padding: 2px 6px;
            background: var(--bg-hover);
            white-space: nowrap;
        }

        /* 仅在桌面端 (宽度 > 768px) 显示快捷键提示 */
        @media (min-width: 768px) {
            .shortcut-hint { display: block; }
        }

        /* === 回到顶部按钮 === */
        .back-to-top {
            position: fixed; bottom: 20px; right: 20px;
            width: 45px; height: 45px; border-radius: 50%;
            background: var(--color-primary); color: var(--text-inverse);
            border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px var(--shadow-heavy);
            opacity: 0; visibility: hidden; transition: all 0.3s ease;
            z-index: 999;
        }
        .back-to-top.show { opacity: 1; visibility: visible; transform: translateY(0); }
        .back-to-top:hover { background: var(--color-primary-dark); transform: translateY(-3px); }


        .app-footer {
            margin-top: 40px; padding: 20px 10px; text-align: center;
            font-size: 14px; color: var(--text-tertiary);
            border-top: 1px solid var(--shadow-base);
            background: linear-gradient(to top, rgba(0,0,0,0.03), transparent);
        }
        .footer-link {
            display: inline-flex; align-items: center; gap: 8px;
            color: var(--text-secondary); text-decoration: none; font-weight: 500;
            transition: all 0.25s ease;
        }
        .footer-link:hover { color: var(--color-primary); }
        .footer-link svg { transition: transform 0.25s ease; fill: currentColor; }
        .footer-link:hover svg { transform: scale(1.15); }
        .footer-copyright { margin-top: 8px; font-size: 12px; color: var(--text-tertiary); }
    </style>
    <script>
        // 解决暗色模式下刷新闪烁白色
        (function() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            let currentTheme = 'light';
            if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
                currentTheme = 'dark';
            }
            // 立即设置，在页面渲染前生效
            document.documentElement.setAttribute('data-theme', currentTheme);
        })();
    </script>
</head>
<body>
<div class="container">
    <header>
        <div>
            <h1 data-i18n="appTitle">任务跟踪器</h1>
            <p class="subtitle" data-i18n="appSubtitle">基于截止日期的任务管理</p>
        </div>
        <div class="header-actions">
            <button class="icon-btn" id="themeToggleBtn" aria-label="切换主题" data-i18n-aria-label="themeTooltip" data-i18n-title="themeTooltip" title="切换主题">
                <svg class="moon-icon svg-no-fill" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <svg class="sun-icon svg-no-fill" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 1V3M12 21V23M4.22 4.22L5.64 5.64M18.36 18.36L19.78 19.78M1 12H3M21 12H23M4.22 19.78L5.64 18.36M18.36 5.64L19.78 4.22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <button class="icon-btn" id="openModalBtn" aria-label="添加新任务" data-i18n-aria-label="addNewTask" data-i18n-title="addNewTaskTooltip" title="添加新任务 (Ctrl+I)">
                <svg class="svg-no-fill" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-linecap="round" stroke-width="2"/>
                </svg>
            </button>
            <button class="icon-btn" id="openMenuBtn" aria-label="打开菜单" data-i18n-aria-label="openMenu" aria-haspopup="true" aria-expanded="false" data-i18n-title="menuTooltip" title="菜单 (Ctrl+M)">
                <svg height="18" viewBox="0 0 24 24" width="18" style="fill: currentColor" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 12C4 11.4477 4.44772 11 5 11H19C19.5523 11 20 11.4477 20 12C20 12.5523 19.5523 13 19 13H5C4.44772 13 4 12.5523 4 12Z"/>
                    <path d="M4 6C4 5.44772 4.44772 5 5 5H19C19.5523 5 20 5.44772 20 6C20 6.55228 19.5523 7 19 7H5C4.44772 7 4 6.55228 4 6Z"/>
                    <path d="M4 18C4 17.4477 4.44772 17 5 17H19C19.5523 17 20 17.4477 20 18C20 18.5523 19.5523 19 19 19H5C4.44772 19 4 18.5523 4 18Z"/>
                </svg>
            </button>
            <div class="menu" id="menu">
                <button class="menu-item" data-i18n-title="export" id="exportBtn" title="导出">
                    <svg class="svg-no-fill" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 4V16M12 4L8 8M12 4L16 8" stroke="currentColor" stroke-width="2"/>
                        <path d="M4 20H20" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <span data-i18n="export">导出</span>
                </button>
                <button class="menu-item" data-i18n-title="import" id="importBtn" title="导入">
                    <svg class="svg-no-fill" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 20V8M12 20L8 16M12 20L16 16" stroke="currentColor" stroke-width="2"/>
                        <path d="M4 4H20" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <span data-i18n="import">导入</span>
                </button>

                <div class="menu-divider"></div>

                <button class="menu-item" data-i18n-title="clearCompletedTitle" id="clearCompletedBtn" title="清除所有已完成的任务">
                    <svg class="svg-no-fill" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px; color: var(--color-danger); fill: none;">
                        <path d="M5.75 5.75C5.75 4.7835 6.5335 4 7.5 4H16.5C17.4665 4 18.25 4.7835 18.25 5.75V8.25H5.75V5.75Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M4 8.25H20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M17.5 8.25V17.5C17.5 18.8807 16.3807 20 15 20H9C7.61929 20 6.5 18.8807 6.5 17.5V8.25" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9.5 11.25V16.25" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M14.5 11.25V16.25" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span data-i18n="clearCompleted">清除已完成</span>
                </button>

                <div class="menu-divider"></div>
                <button class="menu-item" id="langMenuToggle" aria-haspopup="true" aria-expanded="false">
                    <svg viewBox="0 0 24 24" class="svg-no-fill" xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px; color: var(--color-primary); fill: none;">
                        <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2Z" stroke="currentColor" stroke-width="2"/>
                        <path d="M2 12H22" stroke="currentColor" stroke-width="2"/>
                        <path d="M12 2C14.7614 2 17 6.48 17 12C17 17.52 14.7614 22 12 22C9.23858 22 7 17.52 7 12C7 6.48 9.23858 2 12 2Z" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <span data-i18n="language" style="margin-left: 10px;">语言</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" class="svg-no-fill" style="margin-left: auto; transition: transform 0.2s;" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <div class="submenu" id="langSubmenu">
                    <div id="lang-container"></div>
                </div>
            </div>
        </div>
        <input accept=".json" class="file-input" id="importFile" type="file">
    </header>
    <div class="main-content">
        <div class="search-box">
            <label for="searchInput" class="sr-only" data-i18n="searchPlaceholder">搜索任务...</label>
            <input class="search-input" data-i18n-placeholder="searchPlaceholder" id="searchInput" placeholder="搜索任务..." type="text">
            <div class="shortcut-hint">
                <kbd class="shortcut-kbd" title="Ctrl + K">⌘K</kbd>
            </div>
        </div>
        <div class="filters" role="toolbar" aria-label="任务筛选器">
            <button class="filter-btn" data-filter="all" data-i18n="filterAll" aria-pressed="false">全部</button>
            <button class="filter-btn active" data-filter="active" data-i18n="filterActive" aria-pressed="true">进行中</button>
            <button class="filter-btn" data-filter="completed" data-i18n="filterCompleted" aria-pressed="false">已完成</button>
            <button class="filter-btn" data-filter="overdue" data-i18n="filterOverdue" aria-pressed="false">已过期</button>
            <button class="filter-btn" data-filter="no-deadline" data-i18n="filterNoDeadline" aria-pressed="false">无截止日期</button>
        </div>

        <!-- 任务展示区域 -->
        <div class="tasks-section">
            <div id="taskList" aria-live="polite">
                <div class="loading-state" id="initial-loader">
                    <div class="spinner"></div>
                </div>
                <!-- 任务将通过JavaScript动态添加 -->
            </div>
        </div>
    </div>
</div>

<button id="backToTopBtn" class="back-to-top" aria-label="回到顶部" data-i18n-aria-label="backToTopTooltip" data-i18n-title="backToTopTooltip" title="回到顶部 (Alt + T)">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M18 15l-6-6-6 6"/>
    </svg>
</button>

<div class="modal" id="taskModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" data-i18n="addNewTask" id="modalTitle">添加新任务</h3>
            <button class="close-btn" id="closeModalBtn">&times;</button>
        </div>
        <div class="modal-body">
            <form id="taskForm">
                <div class="form-group">
                    <label data-i18n="taskNameLabel" for="taskName">任务名称 *</label>
                    <input data-i18n-placeholder="taskNamePlaceholder" id="taskName" name="taskName" placeholder="输入任务名称" required type="text">
                </div>
                <div class="form-group">
                    <label data-i18n="taskDescLabel" for="taskDesc">任务描述 (可选)</label>
                    <textarea data-i18n-placeholder="taskDescPlaceholder" id="taskDesc" placeholder="输入任务描述"></textarea>
                </div>
                <div class="form-group">
                    <label data-i18n="dueDateLabel" for="dueDate">截止日期 (可选)</label>
                    <div class="datetime-group">
                        <input class="date-input" id="dueDate" type="date">
                        <label for="dueTime" class="sr-only" data-i18n="dueTimeLabel">截止时间</label>
                        <input class="time-input" id="dueTime" type="time" value="23:59">
                    </div>
                    <div class="checkbox-group">
                        <label data-i18n="noDeadlineLabel" for="noDeadline">无截止日期</label>
                        <input id="noDeadline" type="checkbox">
                    </div>
                </div>
                <div class="form-actions">
                    <button class="btn btn-secondary" data-i18n="cancel" id="cancelBtn" type="button">取消</button>
                    <button class="btn btn-primary" data-i18n="addTask" id="submitBtn" type="submit">添加任务</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="notification" id="notification" role="status" aria-live="polite">
    <svg class="svg-no-fill" height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg">
        <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
    </svg>
    <span id="notificationText"></span>
</div>

<template id="task-template">
    <div class="task-item">
        <div class="task-header">
            <div class="task-title">
                <svg width="16" height="16" viewBox="0 0 24 24" class="svg-no-fill" xmlns="http://www.w3.org/2000/svg">
                    <path d="M20 6L9 17L4 12" stroke="var(--color-success)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span class="task-name"></span>
            </div>
            <div class="task-date"></div>
        </div>
        <div class="task-desc"></div>
        <div class="progress-bar">
            <div class="progress-fill"></div>
        </div>
        <div class="task-footer">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span class="status-text"></span> <span class="status-time-left"></span> </div>
            <div class="task-actions">
                <button class="action-btn complete-btn" data-action="toggle" title="标记完成">
                    <svg width="18" height="18" viewBox="0 0 24 24" class="svg-no-fill" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button class="action-btn edit-btn" data-action="edit" title="编辑">
                    <svg width="18" height="18" viewBox="0 0 24 24" class="svg-no-fill" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M18.5 2.5C18.8978 2.10217 19.4374 1.87868 20 1.87868C20.5626 1.87868 21.1022 2.10217 21.5 2.5C21.8978 2.89782 22.1213 3.43739 22.1213 4C22.1213 4.56261 21.8978 5.10217 21.5 5.5L12 15L8 16L9 12L18.5 2.5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button class="action-btn delete-btn" data-action="delete" title="删除">
                    <svg width="18" height="18" viewBox="0 0 24 24" class="svg-no-fill" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 7L18.1327 19.1425C18.0579 20.1891 17.187 21 16.1378 21H7.86224C6.81296 21 5.94208 20.1891 5.86732 19.1425L5 7M10 11V17M14 11V17M15 7V4C15 3.44772 14.5523 3 14 3H10C9.44772 3 9 3.44772 9 4V7M4 7H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</template>

<footer class="app-footer">
    <a href="https://github.com/muquew/Todo-Manager" target="_blank" class="footer-link">
        <svg height="18" viewBox="0 0 24 24" width="18" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 0C5.37 0 0 5.373 0 12c0 5.303 3.438 9.8 8.205 11.387.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.727-4.042-1.61-4.042-1.61-.546-1.387-1.333-1.757-1.333-1.757 -1.09-.745.083-.729.083-.729 1.205.085 1.84 1.238 1.84 1.238 1.07 1.835 2.807 1.305 3.492.998.108-.775.418-1.305.76-1.606-2.665-.305-5.466-1.334-5.466-5.932 0-1.31.47-2.382 1.236-3.22-.125-.303-.535-1.523.115-3.176 0 0 1.008-.322 3.3 1.23a11.49 11.49 0 013.004-.404 c1.02.005 2.045.138 3.003.404 2.292-1.552 3.3-1.23 3.3-1.23.65 1.653.24 2.873.12 3.176.77.838 1.236 1.91 1.236 3.22 0 4.61-2.804 5.624-5.475 5.922.43.372.81 1.102.81 2.222 0 1.606-.015 2.896-.015 3.286 0 .32.216.694.825.576C20.565 21.796 24 17.3 24 12 24 5.373 18.627 0 12 0z"/>
        </svg>
        GitHub
    </a>
    <div class="footer-copyright">
        © 2025 muquew · Personal Non-Commercial License
    </div>
</footer>

<script>
    (function() {
        // IndexedDB 配置
        const DB_NAME = 'TaskTrackerDB';
        const DB_VERSION = 2;
        const STORE_NAME = 'tasks';
        const CONFIG_STORE_NAME = 'config';

        // 状态变量
        let db = null;
        let tasks = [];
        let currentFilter = 'active'; // 默认改为 'active'
        let searchQuery = '';
        let editingTaskId = null;
        let progressUpdateInterval = null;
        let currentLanguage = 'zh-CN';

        // DOM 元素 (在 DOMContentLoaded 中初始化)
        let taskForm, taskList, taskModal, openModalBtn, closeModalBtn, cancelBtn,
            noDeadlineCheckbox, dueDateInput, dueTimeInput, modalTitle, submitBtn,
            searchInput, notification, notificationText, taskTemplate, importBtn, exportBtn,
            importFileInput, openMenuBtn, menu, langMenuToggle, langSubmenu, clearCompletedBtn,
            formGroups, themeToggleBtn, backToTopBtn,
            elementToFocusOnClose = null; // A11y: 存储关闭弹窗时要聚焦的元素

        const LANG_RESOURCES = [
            { code: 'zh-CN', name: '简体中文' },
            { code: 'en', name: 'English' }
        ];
        const translations = {};

        // 初始化应用
        document.addEventListener('DOMContentLoaded', async function () {
            // 缓存 DOM 元素
            taskForm = document.getElementById('taskForm');
            taskList = document.getElementById('taskList');
            taskModal = document.getElementById('taskModal');
            openModalBtn = document.getElementById('openModalBtn');
            closeModalBtn = document.getElementById('closeModalBtn');
            cancelBtn = document.getElementById('cancelBtn');
            noDeadlineCheckbox = document.getElementById('noDeadline');
            dueDateInput = document.getElementById('dueDate');
            dueTimeInput = document.getElementById('dueTime');
            modalTitle = document.getElementById('modalTitle');
            submitBtn = document.getElementById('submitBtn');
            searchInput = document.getElementById('searchInput');
            notification = document.getElementById('notification');
            notificationText = document.getElementById('notificationText');
            taskTemplate = document.getElementById('task-template');
            exportBtn = document.getElementById('exportBtn');
            importBtn = document.getElementById('importBtn');
            importFileInput = document.getElementById('importFile');
            openMenuBtn = document.getElementById('openMenuBtn');
            menu = document.getElementById('menu');
            langMenuToggle = document.getElementById('langMenuToggle');
            langSubmenu = document.getElementById('langSubmenu');
            clearCompletedBtn = document.getElementById('clearCompletedBtn');
            formGroups = document.querySelectorAll('.form-group');
            themeToggleBtn = document.getElementById('themeToggleBtn');
            backToTopBtn = document.getElementById('backToTopBtn');

            try {
                // 加载翻译
                await loadTranslations();
                createLangButtons();

                await initDB();
                // 从配置中获取语言设置
                const savedLanguage = await getConfig('language');
                if (savedLanguage) {
                    currentLanguage = savedLanguage;
                } else {
                    // 获取系统语言列表，优先使用第一个支持的语言
                    const languages = navigator.languages || [navigator.language];
                    // 在系统语言列表中查找支持的语言
                    const supportedLang = languages.find(lang => translations[lang] || translations[lang.split('-')[0]]);
                    currentLanguage = supportedLang
                        ? translations[supportedLang] ? supportedLang : supportedLang.split('-')[0]
                        : LANG_RESOURCES[0]?.code || 'en';
                    if (!translations[currentLanguage]) {
                        currentLanguage = Object.keys(translations)[0]; // 最后的备用
                    }
                    await setConfig('language', currentLanguage);
                }

                initLanguage();
                setupEventListeners();

                tasks = await getAllTasks();
                setFilter(currentFilter); // 应用默认筛选器
                renderTasks();

                // 设置最小日期为今天
                dueDateInput.min = new Date().toISOString().split('T')[0];

                // 使用IndexedDB检查是否已添加示例任务
                const sampleTasksAdded = await getConfig('sampleTasksAdded');
                if (tasks.length === 0 && !sampleTasksAdded) {
                    await addSampleTasks();
                    await setConfig('sampleTasksAdded', true);
                }

                // 启动进度条更新定时器
                startProgressUpdate();
            } catch (error) {
                console.error('初始化失败:', error);
                showNotification(translations[currentLanguage]['initDBError'] || '数据库初始化失败，请刷新页面重试', 'error');
            }
        });

        function setupEventListeners() {
            // 主题
            themeToggleBtn.addEventListener('click', toggleTheme);
            // 弹窗控制
            openModalBtn.addEventListener('click', openAddTaskModal);
            closeModalBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);
            taskModal.addEventListener('click', (e) => {
                if (e.target === taskModal) closeModal();
            });

            // 表单
            taskForm.addEventListener('submit', handleFormSubmit);
            noDeadlineCheckbox.addEventListener('change', function () {
                dueDateInput.disabled = this.checked;
                dueTimeInput.disabled = this.checked;
                if (this.checked) {
                    dueDateInput.value = new Date().toISOString().split('T')[0];
                    dueTimeInput.value = '23:59';
                }
            });

            // 筛选和搜索
            searchInput.addEventListener('input', debounce(filterTasks, 300));
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => setFilter(btn.dataset.filter));
            });

            clearCompletedBtn.addEventListener('click', clearCompletedTasks);

            // 菜单
            const closeMainMenu = () => {
                menu.classList.remove('show');
                openMenuBtn.setAttribute('aria-expanded', false);
                langSubmenu.classList.remove('show');
                langMenuToggle.classList.remove('open');
                langMenuToggle.setAttribute('aria-expanded', false);
            };
            const toggleMainMenu = () => {
                const isOpening = !menu.classList.contains('show');
                if (isOpening) {
                    menu.classList.add('show');
                    openMenuBtn.setAttribute('aria-expanded', true);
                } else {
                    closeMainMenu();
                }
            };
            openMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleMainMenu();
            });
            // 点击外部关闭菜单
            document.addEventListener('click', function(e) {
                if (menu.classList.contains('show') && !menu.contains(e.target) && !openMenuBtn.contains(e.target)) {
                    closeMainMenu();
                }
            });

            // A11y: 添加 aria-expanded
            langMenuToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                const isOpening = !langSubmenu.classList.contains('show'); // 检查是否即将打开
                langSubmenu.classList.toggle('show');
                langMenuToggle.classList.toggle('open');
                langMenuToggle.setAttribute('aria-expanded', isOpening); // <-- A11y
            });

            // 语言切换
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.addEventListener('click', () => switchLanguage(btn.dataset.lang));
            });

            // 导入/导出事件监听
            exportBtn.addEventListener('click', exportTasks);
            importBtn.addEventListener('click', () => importFileInput.click());
            importFileInput.addEventListener('change', (e) => importTasks(e.target.files[0]));

            // 任务列表事件委托
            taskList.addEventListener('click', function(e) {
                const button = e.target.closest('.action-btn');
                if (!button) return;

                const taskItem = button.closest('.task-item');
                if (!taskItem) return;

                const taskId = Number(taskItem.dataset.taskId);
                const action = button.dataset.action;

                switch (action) {
                    case 'toggle': toggleTaskComplete(taskId); break;
                    case 'edit': editTask(taskId); break;
                    case 'delete': deleteTask(taskId); break;
                }
            });
            // 页面从休眠恢复
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    if (progressUpdateInterval) clearInterval(progressUpdateInterval);
                } else {
                    updateTaskTimers(); // 回来时立即更新一次
                    startProgressUpdate(); // 重启定时器
                }
            });

            // --- 全局键盘快捷键 ---
            document.addEventListener('keydown', (e) => {
                const isCtrlOrMeta = e.ctrlKey || e.metaKey;
                // 1. Ctrl/Cmd + K: 聚焦搜索
                if (isCtrlOrMeta && e.key === 'k') {
                    e.preventDefault();
                    searchInput.focus();
                }
                // 2. Ctrl/Cmd + I: 新建任务
                if (isCtrlOrMeta && e.key === 'i') {
                    e.preventDefault();
                    if (taskModal.style.display !== 'flex') {
                        openAddTaskModal();
                    }
                }
                // 3. Ctrl/Cmd + M: 切换菜单 (新增功能)
                if (isCtrlOrMeta && e.key === 'm') {
                    e.preventDefault();
                    toggleMainMenu();
                }
                // 4. Alt + T: 平滑回到顶部
                if (e.altKey && e.key.toLowerCase() === 't') {
                    e.preventDefault();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
                // 5. Esc: 关闭操作
                if (e.key === 'Escape') {
                    if (taskModal.style.display === 'flex') {
                        closeModal();
                    } else if (document.activeElement === searchInput) {
                        searchInput.blur();
                    } else if (menu.classList.contains('show')) {
                        closeMainMenu();
                    }
                }
            });

            // Back to Top
            window.addEventListener('scroll', () => {
                if (window.scrollY > 300) {
                    backToTopBtn.classList.add('show');
                } else {
                    backToTopBtn.classList.remove('show');
                }
            });
            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }

        function showNotification(message, type = 'success') {
            notificationText.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type);

            // A11y: 根据类型设置 role
            if (type === 'error' || type === 'warning') {
                notification.setAttribute('role', 'alert');
            } else {
                notification.setAttribute('role', 'status');
            }

            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        function showConfirmModal(title, message, onConfirm) {
            const langMap = translations[currentLanguage];

            // 1. 设置弹窗标题和信息
            modalTitle.textContent = title;

            let confirmMessageEl = document.getElementById('confirm-message-text');
            if (!confirmMessageEl) {
                confirmMessageEl = document.createElement('p');
                confirmMessageEl.id = 'confirm-message-text';
                confirmMessageEl.style.fontSize = '16px';
                confirmMessageEl.style.lineHeight = '1.5';
                confirmMessageEl.style.marginBottom = '20px';
                // 插入到表单的开头
                taskForm.prepend(confirmMessageEl);
            }
            confirmMessageEl.textContent = message;
            confirmMessageEl.style.display = 'block';

            // 2. 隐藏表单字段
            formGroups.forEach(group => {
                group.style.display = 'none';
            });

            // 3. 更改按钮
            submitBtn.textContent = langMap['confirm'] || 'Confirm';
            submitBtn.type = 'button'; // 关键！防止它触发表单提交

            // 4. 定义一次性点击事件
            const handleConfirmClick = () => {
                onConfirm(); // 执行传入的回调（例如，删除逻辑）
                closeModal();
            };

            // 存储引用，以便在 closeModal 中移除它
            submitBtn._confirmHandler = handleConfirmClick;

            // 绑定事件
            submitBtn.addEventListener('click', handleConfirmClick);
            cancelBtn.addEventListener('click', closeModal); // cancelBtn 始终是 closeModal

            // 5. 显示弹窗
            elementToFocusOnClose = document.activeElement; // A11y: 存储焦点
            taskModal.style.display = 'flex';
            submitBtn.focus(); // A11y: 焦点移到确认按钮上
        }

        /**
         * 防抖函数
         * @param {Function} func - 需要防抖的函数
         * @param {number} delay - 延迟时间 (毫秒)
         */
        function debounce(func, delay = 300) {
            let timeoutId;

            return function(...args) {
                const context = this;
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(context, args);
                }, delay);
            };
        }

        // --- IndexedDB 数据库操作 ---
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    // 创建任务存储
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, {keyPath: 'id'});
                        store.createIndex('dueDate', 'dueDate', {unique: false});
                    }
                    // 创建配置存储
                    if (!db.objectStoreNames.contains(CONFIG_STORE_NAME)) {
                        db.createObjectStore(CONFIG_STORE_NAME, {keyPath: 'key'});
                    }
                };
            });
        }

        async function getAllTasks() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function addTaskToDB(task) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const taskToStore = {...task, dueDate: task.dueDate || null}; // 明确设置 dueDate 为 null
                const request = store.add(taskToStore);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function updateTaskInDB(task) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(task);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function deleteTaskFromDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        async function getConfig(key) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([CONFIG_STORE_NAME], 'readonly');
                const store = transaction.objectStore(CONFIG_STORE_NAME);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result ? request.result.value : null);
                request.onerror = () => reject(request.error);
            });
        }

        async function setConfig(key, value) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([CONFIG_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(CONFIG_STORE_NAME);
                const request = store.put({key, value});
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // --- 语言与国际化 ---
        async function loadTranslations() {
            try {
                const fetchPromises = LANG_RESOURCES.map(lang =>
                    fetch(`./resources/${lang.code}.json`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`[${response.status}] Failed to load ${lang.code}.json`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            translations[lang.code] = data; // 填充全局翻译对象
                        })
                );

                await Promise.all(fetchPromises);

                if (Object.keys(translations).length === 0) {
                    throw new Error('没有找到语言文件');
                }
            } catch (error) {
                console.error('加载语言失败: ', error);
                // 必须使用一个“硬编码”的后备消息
                showNotification('加载语言失败，请刷新页面重试', 'error');
            }
        }
        function createLangButtons() {
            const container = document.getElementById('lang-container');
            if (!container) return;

            LANG_RESOURCES.forEach(lang => {
                const btn = document.createElement('button');
                btn.className = 'lang-btn';
                btn.dataset.lang = lang.code;
                btn.textContent = lang.name;
                container.appendChild(btn);
            });
        }

        function initLanguage() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === currentLanguage);
            });
            document.documentElement.lang = currentLanguage;
            applyTranslations();
        }

        function applyTranslations() {
            let langMap = translations[currentLanguage];
            if (!langMap) {
                console.warn(`No translations found for language: ${currentLanguage}. Using default.`);
                // 尝试使用第一个可用的翻译
                const fallbackLang = Object.keys(translations)[0];
                if (!fallbackLang) {
                    console.error("No translations available at all.");
                    return; // 无法渲染
                }
                currentLanguage = fallbackLang;
                langMap = translations[currentLanguage];
            }
            // --- 优化：一次性查询和应用所有i18n属性 ---
            const elements = document.querySelectorAll(
                '[data-i18n], [data-i18n-placeholder], [data-i18n-title], [data-i18n-aria-label]'
            );
            // 一次遍历
            elements.forEach(element => {
                // .dataset 会自动处理驼峰命名 (e.g., data-i18n-placeholder -> dataset.i18nPlaceholder)
                const i18nKey = element.dataset.i18n;
                const placeholderKey = element.dataset.i18nPlaceholder;
                const titleKey = element.dataset.i18nTitle;
                const ariaLabelKey = element.dataset.i18nAriaLabel;

                if (i18nKey && langMap[i18nKey]) {
                    element.textContent = langMap[i18nKey];
                }
                if (placeholderKey && langMap[placeholderKey]) {
                    element.placeholder = langMap[placeholderKey];
                }
                if (titleKey && langMap[titleKey]) {
                    element.title = langMap[titleKey];
                }
                if (ariaLabelKey && langMap[ariaLabelKey]) {
                    element.setAttribute('aria-label', langMap[ariaLabelKey]);
                }
            });
            renderTasks();
        }
        function switchLanguage(lang) {
            if (translations[lang]) {
                currentLanguage = lang;
                setConfig('language', lang);
                initLanguage();
            }
        }

        // --- 弹窗与表单逻辑 ---
        function openAddTaskModal() {
            elementToFocusOnClose = document.activeElement; // A11y: 存储当前焦点
            editingTaskId = null;
            modalTitle.setAttribute('data-i18n', 'addNewTask');
            submitBtn.setAttribute('data-i18n', 'addTask');
            taskForm.reset();

            // 重置表单状态
            noDeadlineCheckbox.checked = false;
            dueDateInput.disabled = false;
            dueTimeInput.disabled = false;
            dueDateInput.value = new Date().toISOString().split('T')[0];
            dueTimeInput.value = '23:59';

            taskModal.style.display = 'flex';
            document.getElementById('taskName').focus();
            applyTranslations();
        }

        function closeModal() {
            taskModal.style.display = 'none';
            taskForm.reset();
            editingTaskId = null;

            // 1. 恢复表单字段的显示
            formGroups.forEach(group => {
                group.style.display = 'block';
            });

            // 2. 隐藏确认信息
            const confirmMessageEl = document.getElementById('confirm-message-text');
            if (confirmMessageEl) {
                confirmMessageEl.style.display = 'none';
            }

            // 3. 重置提交按钮
            submitBtn.type = 'submit'; // 恢复为 'submit'

            // 4. 移除临时的确认处理器 (非常重要)
            if (submitBtn._confirmHandler) {
                submitBtn.removeEventListener('click', submitBtn._confirmHandler);
                delete submitBtn._confirmHandler; // 清理引用
            }

            // 恢复按钮的翻译 (openAddTaskModal 或 editTask 会处理)

            // A11y: 恢复焦点
            if (elementToFocusOnClose) {
                elementToFocusOnClose.focus();
                elementToFocusOnClose = null;
            }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const langMap = translations[currentLanguage];

            const taskName = document.getElementById('taskName').value.trim();
            const taskDesc = document.getElementById('taskDesc').value.trim();
            const hasDeadline = !noDeadlineCheckbox.checked;

            let dueDateTime = null;
            if (hasDeadline && dueDateInput.value) {
                dueDateTime = localToUTC(dueDateInput.value, dueTimeInput.value);
            }

            const taskData = {
                name: taskName,
                description: taskDesc,
                dueDate: dueDateTime,
                completed: false
            };

            try {
                if (editingTaskId) {
                    const existingTask = tasks.find(t => t.id === editingTaskId);
                    const updatedTask = {
                        ...existingTask,
                        ...taskData,
                        createdAt: existingTask.createdAt // 保留原始创建时间
                    };
                    await updateTaskInDB(updatedTask);
                    showNotification(langMap['taskUpdated']);
                } else {
                    const newTask = {
                        id: Date.now(),
                        ...taskData,
                        createdAt: new Date().toISOString() // 设置新创建时间
                    };
                    await addTaskToDB(newTask);
                    showNotification(langMap['taskAdded']);
                }

                tasks = await getAllTasks();
                renderTasks();
                closeModal();
            } catch (error) {
                console.error('保存任务失败:', error);
                showNotification(langMap['saveError'], 'error');
            }
        }
        async function clearCompletedTasks() {
            const langMap = translations[currentLanguage];
            const completedTasks = tasks.filter(task => task.completed);

            if (completedTasks.length === 0) {
                showNotification(langMap['noCompletedTasks'], 'warning');
                return;
            }

            showConfirmModal(
                langMap['clearCompleted'],
                (langMap['confirmClearCompleted']).replace('{count}', completedTasks.length.toString()),
                async () => { // "确认" 按钮的回调
                    try {
                        const deletionPromises = completedTasks.map(task => deleteTaskFromDB(task.id));
                        await Promise.all(deletionPromises);

                        tasks = tasks.filter(task => !task.completed);

                        renderTasks();

                        showNotification((langMap['completedTasksCleared']).replace('{count}', completedTasks.length));
                    } catch (error) {
                        console.error('清除已完成任务失败:', error);
                        showNotification(langMap['clearCompletedError'], "error");
                    }
                }
            );

        }

        // --- 任务 CRUD 操作 (由事件委托调用) ---
        function editTask(id) {
            const task = tasks.find(t => t.id === id);
            if (!task) return;

            elementToFocusOnClose = document.activeElement; // A11y: 存储焦点
            editingTaskId = id;
            modalTitle.setAttribute('data-i18n', 'editTask');
            submitBtn.setAttribute('data-i18n', 'updateTask');

            document.getElementById('taskName').value = task.name;
            document.getElementById('taskDesc').value = task.description || '';

            if (task.dueDate) {
                const localDate = utcToLocal(task.dueDate);
                dueDateInput.value = localDate.toISOString().split('T')[0];
                dueTimeInput.value = `${localDate.getHours().toString().padStart(2, '0')}:${localDate.getMinutes().toString().padStart(2, '0')}`;
                noDeadlineCheckbox.checked = false;
                dueDateInput.disabled = false;
                dueTimeInput.disabled = false;
            } else {
                noDeadlineCheckbox.checked = true;
                dueDateInput.disabled = true;
                dueTimeInput.disabled = true;
                dueDateInput.value = new Date().toISOString().split('T')[0];
                dueTimeInput.value = '23:59';
            }

            taskModal.style.display = 'flex';
            document.getElementById('taskName').focus();
            applyTranslations();
        }

        async function deleteTask(id) {
            const langMap = translations[currentLanguage];

            showConfirmModal(
                langMap['deleteTaskTitle'], // 弹窗标题
                langMap['confirmDelete'],   // 确认信息
                async () => {
                    try {
                        await deleteTaskFromDB(id);
                        tasks = tasks.filter(task => task.id !== id);
                        renderTasks();
                        showNotification(langMap['taskDeleted']);
                    } catch (error) {
                        console.error('删除任务失败:', error);
                        showNotification(langMap['deleteError'], 'error');
                    }
                }
            );
        }

        async function toggleTaskComplete(id) {
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            const langMap = translations[currentLanguage];

            const updatedTask = {...task, completed: !task.completed};

            try {
                await updateTaskInDB(updatedTask);
                tasks = await getAllTasks();

                const taskElement = document.querySelector(`.task-item[data-task-id="${id}"]`);
                if (updatedTask.completed) {
                    taskElement.classList.add('animate-complete');
                    setTimeout(() => taskElement.classList.remove('animate-complete'), 500);
                    showNotification(langMap['taskMarkedComplete']);
                } else {
                    showNotification(langMap['taskMarkedIncomplete']);
                }

                renderTasks();
            } catch (error) {
                console.error('更新任务状态失败:', error);
                showNotification(langMap['updateError'], 'error');
            }
        }

        // --- 渲染、筛选、排序 ---
        function startProgressUpdate() {
            if (progressUpdateInterval) clearInterval(progressUpdateInterval);
            // 调用新的轻量级函数，而不是完整的 renderTasks
            progressUpdateInterval = setInterval(updateTaskTimers, 60000); // 1分钟
        }

        function setFilter(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const isActive = btn.dataset.filter === filter;
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-pressed', String(isActive)); // <-- A11y
            });
            renderTasks();
        }

        function filterTasks() {
            searchQuery = searchInput.value.toLowerCase();
            renderTasks();
        }

        function sortTasks(taskList) {
            return taskList.sort((a, b) => {
                // 首先，已完成的放在最后
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                // 然后，无截止日期的放在有截止日期的后面
                if (!a.dueDate && b.dueDate) return 1;
                if (a.dueDate && !b.dueDate) return -1;
                // 如果都有截止日期，按截止日期排序
                if (a.dueDate && b.dueDate) return new Date(a.dueDate) - new Date(b.dueDate);
                // 如果都没有截止日期，按创建时间排序
                return new Date(a.createdAt) - new Date(b.createdAt);
            });
        }

        // 新增一个轻量级更新函数
        function updateTaskTimers() {
            const langMap = translations[currentLanguage];
            if (!langMap) return;

            // 仅遍历当前DOM中未完成的任务项
            document.querySelectorAll('.task-item:not(.completed-task)').forEach(taskElement => {
                const taskId = Number(taskElement.dataset.taskId);
                const task = tasks.find(t => t.id === taskId);

                if (!task || !task.dueDate) return; // 如果找不到任务或没有截止日期，则跳过

                // 1. 重新计算时间和状态
                const timeLeft = calculateTimeLeft(task.dueDate);
                const status = getStatus(timeLeft);

                // 2. 更新状态文本
                const statusIndicator = taskElement.querySelector('.status-indicator');
                // 清除旧的状态类名，保留基础类名
                statusIndicator.className = 'status-indicator';
                statusIndicator.classList.add(status.statusClass);
                statusIndicator.querySelector('.status-text').textContent = status.text;

                // 3. 更新剩余时间
                const timeLeftEl = statusIndicator.querySelector('.status-time-left');
                if (timeLeftEl) { // 确保元素存在
                    timeLeftEl.textContent = `(${formatTimeLeft(timeLeft)})`;
                }

                // 4. 更新进度条
                const progressBarEl = taskElement.querySelector('.progress-bar');
                if (progressBarEl) {
                    const progressFill = progressBarEl.querySelector('.progress-fill');
                    progressFill.style.width = `${status.progress}%`;
                }

                // 5. 更新任务项的 class
                // 移除所有可能的状态类
                taskElement.classList.remove('status-safe', 'status-warning', 'status-danger', 'status-no-deadline');
                // 添加新的状态类
                if (status.statusClass) {
                    taskElement.classList.add(status.statusClass);
                }
            });
        }

        // --- 新增：核心渲染逻辑 (复用代码) ---
        function renderTaskContent(taskElement, task) {
            const langMap = translations[currentLanguage];

            // 1. 计算状态
            let status, timeLeft = null;
            if (task.completed) {
                status = { statusClass: 'status-completed', text: langMap['statusCompleted'], progress: 100 };
            } else if (task.dueDate) {
                timeLeft = calculateTimeLeft(task.dueDate);
                status = getStatus(timeLeft);
            } else {
                status = { statusClass: 'status-no-deadline', text: langMap['statusNoDeadline'], progress: 0 };
            }

            // 2. 设置 CSS 类名
            // 移除旧的状态类
            taskElement.classList.remove('status-safe', 'status-warning', 'status-danger', 'status-no-deadline', 'completed-task');
            // 添加新状态
            if (status.statusClass) taskElement.classList.add(status.statusClass);
            if (task.completed) taskElement.classList.add('completed-task');

            // 3. 头部信息 (名称 & 日期)
            taskElement.querySelector('.task-name').textContent = task.name;
            taskElement.querySelector('.task-date').textContent = task.dueDate ?
                `${langMap['deadline']}: ${formatDateTime(task.dueDate)}` :
                langMap['noDeadlineText'];

            // 4. 描述 (动态插入或移除)
            let taskDescEl = taskElement.querySelector('.task-desc');
            if (task.description) {
                if (!taskDescEl) { // 如果模板中没有，（理论上不该发生）
                    taskDescEl = document.createElement('div');
                    taskDescEl.className = 'task-desc';
                    taskElement.querySelector('.task-header').after(taskDescEl);
                }
                taskDescEl.textContent = task.description;
            } else if (taskDescEl) {
                taskDescEl.remove(); // 移除空描述
            }

            // 5. 进度条 (动态插入或移除)
            let progressBarEl = taskElement.querySelector('.progress-bar');
            if (task.dueDate && !task.completed) {
                if (!progressBarEl) {
                    progressBarEl = document.createElement('div');
                    progressBarEl.className = 'progress-bar';
                    progressBarEl.innerHTML = '<div class="progress-fill"></div>';
                    // 插入位置判断：有描述插描述后，无描述插Header后
                    const refEl = taskElement.querySelector('.task-desc') || taskElement.querySelector('.task-header');
                    refEl.after(progressBarEl);
                }
                // 只需要设置宽度，颜色由 CSS 变量自动处理
                progressBarEl.querySelector('.progress-fill').style.width = `${status.progress}%`;
            } else if (progressBarEl) {
                progressBarEl.remove();
            }

            // 6. 底部状态栏
            const statusIndicator = taskElement.querySelector('.status-indicator');
            // 注意：这里不需要再手动设置 statusIndicator 的 class 来改变颜色，
            // 因为颜色现在由父级 .task-item 的 class 控制
            statusIndicator.querySelector('.status-text').textContent = status.text;

            let timeLeftEl = statusIndicator.querySelector('.status-time-left');
            if (task.dueDate && !task.completed) {
                if (!timeLeftEl) {
                    timeLeftEl = document.createElement('span');
                    timeLeftEl.className = 'status-time-left';
                    statusIndicator.querySelector('.status-text').after(timeLeftEl);
                }
                timeLeftEl.textContent = `(${formatTimeLeft(timeLeft)})`;
            } else if (timeLeftEl) {
                timeLeftEl.remove();
            }

            // 7. 按钮 Tooltips
            const completeBtn = taskElement.querySelector('[data-action="toggle"]');
            if(completeBtn) completeBtn.title = task.completed ? langMap['markIncomplete'] : langMap['markComplete'];

            // 可以在这里统一更新编辑和删除按钮的 title，虽然它们通常不变
            const editBtn = taskElement.querySelector('[data-action="edit"]');
            if(editBtn) editBtn.title = langMap['editTaskTitle'];
            const deleteBtn = taskElement.querySelector('[data-action="delete"]');
            if(deleteBtn) deleteBtn.title = langMap['deleteTaskTitle'];
        }

        // --- 极度简化的 Create 和 Update 函数 ---

        function createTaskElement(task) {
            const templateContent = taskTemplate.content;
            const taskElement = templateContent.cloneNode(true).firstElementChild;
            taskElement.dataset.taskId = task.id;

            // 调用核心渲染函数
            renderTaskContent(taskElement, task);

            return taskElement;
        }

        function updateTaskElement(element, task) {
            // 调用核心渲染函数
            renderTaskContent(element, task);
        }


        function renderTasks() {
            const langMap = translations[currentLanguage];
            if (!langMap) return;

            // --- 1. 计算统计 (保持不变) ---
            // const totalTasks = tasks.length;
            // const activeTasks = tasks.filter(task => !task.completed).length;
            // const completedTasks = tasks.filter(task => task.completed).length;
            // const tasksWithoutDeadline = tasks.filter(task => !task.dueDate).length;
            // const overdueTasks = tasks.filter(task => {
            //     return !task.completed && task.dueDate && new Date(task.dueDate) < new Date();
            // }).length;

            // --- 2. 空状态 (保持不变) ---
            if (tasks.length === 0) {
                taskList.innerHTML = `
                <div class="empty-state">
                    <svg width="80" height="80" viewBox="0 0 24 24" class="svg-no-fill" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 5H7C5.89543 5 5 5.89543 5 7V19C5 20.1046 5.89543 21 7 21H17C18.1046 21 19 20.1046 19 19V7C19 5.89543 18.1046 5 17 5H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 12H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 16H15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5V7H9V5Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 12H9.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 16H9.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <h3>${langMap['noTasks']}</h3>
                    <p>${langMap['noTasksDescription']}</p>
                </div>`;
                return;
            }

            // 移除加载器
            const initialLoader = document.getElementById('initial-loader');
            if (initialLoader) {
                initialLoader.remove();
            }

            // --- 3. 筛选与排序 (保持不变) ---
            const filteredTasks = tasks.filter(task => {
                if (searchQuery && !task.name.toLowerCase().includes(searchQuery) &&
                    !(task.description && task.description.toLowerCase().includes(searchQuery))) {
                    return false;
                }
                switch (currentFilter) {
                    case 'active': return !task.completed;
                    case 'completed': return task.completed;
                    case 'overdue': return !task.completed && task.dueDate && new Date(task.dueDate) < new Date();
                    case 'no-deadline': return !task.dueDate;
                    default: return true;
                }
            });

            const sortedTasks = sortTasks(filteredTasks);

            // --- 4. 筛选后的空状态 (保持不变) ---
            if (sortedTasks.length === 0) {
                taskList.innerHTML = `
                <div class="empty-state">
                    <svg width="80" height="80" viewBox="0 0 24 24" class="svg-no-fill" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9.172 16.242L12 13.414L14.828 16.242L16.242 14.828L13.414 12L16.242 9.172L14.828 7.758L12 10.586L9.172 7.758L7.758 9.172L10.586 12L7.758 14.828L9.172 16.242Z" fill="currentColor"/>
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M12 22C17.523 22 22 17.523 22 12C22 6.477 17.523 2 12 2C6.477 2 2 6.477 2 12C2 17.523 6.477 22 12 22ZM12 20C16.418 20 20 16.418 20 12C20 7.582 16.418 4 12 4C7.582 4 4 7.582 4 12C4 16.418 7.582 20 12 20Z" fill="currentColor"/>
                    </svg>
                    <h3>${langMap['noMatchingTasks']}</h3>
                    <p>${langMap['noMatchingTasksDescription']}</p>
                </div>`;
                return;
            }

            // 在开始和解之前，移除任何残留的空状态
            const existingEmptyState = taskList.querySelector('.empty-state');
            if (existingEmptyState) {
                existingEmptyState.remove();
            }

            // --- 5. DOM 和解 (全新逻辑) ---

            // A. 将当前 DOM 元素映射到 Map 中，以便通过 ID 快速访问
            const elementsMap = new Map();
            Array.from(taskList.children).forEach(el => {
                // 确保只映射任务项，忽略 .empty-state
                if (el.classList.contains('task-item')) {
                    elementsMap.set(Number(el.dataset.taskId), el);
                }
            });

            // B. 遍历 "目标" 任务数组，同步 DOM
            let currentElement = taskList.firstChild;

            for (const task of sortedTasks) {
                const taskId = task.id;
                const existingElement = elementsMap.get(taskId);

                if (existingElement) {
                    // --- 5.1 元素已存在 ---
                    // 更新内容
                    updateTaskElement(existingElement, task);

                    // 检查顺序
                    if (existingElement !== currentElement) {
                        taskList.insertBefore(existingElement, currentElement);
                    }

                    // 标记为 "已处理"
                    elementsMap.delete(taskId);
                    currentElement = existingElement.nextSibling;

                } else {
                    // --- 5.2 新元素 ---
                    const newElement = createTaskElement(task);
                    taskList.insertBefore(newElement, currentElement);
                    // 不移动 currentElement，因为 newElement 现在就是 "当前"
                }
            }

            // C. 移除陈旧的元素
            // 循环结束后，elementsMap 中剩下的都是应被删除的元素
            elementsMap.forEach(staleElement => {
                staleElement.remove();
            });
        }

        // --- 示例任务 ---
        async function addSampleTasks() {
            const langMap = translations[currentLanguage];
            const sampleTasks = [
                {
                    id: Date.now() + 1,
                    name: langMap['sampleTask1Name'] || "完成项目报告",
                    description: langMap['sampleTask1Desc'] || "编写并提交季度项目总结报告",
                    dueDate: new Date(new Date().getTime() + 5 * 24 * 60 * 60 * 1000).toISOString(),
                    createdAt: new Date().toISOString(),
                    completed: false
                },
                {
                    id: Date.now() + 2,
                    name: langMap['sampleTask2Name'] || "团队会议准备",
                    description: langMap['sampleTask2Desc'] || "准备下周团队会议的演示材料",
                    dueDate: new Date(new Date().getTime() + 10 * 24 * 60 * 60 * 1000).toISOString(),
                    createdAt: new Date().toISOString(),
                    completed: false
                },
                {
                    id: Date.now() + 3,
                    name: langMap['sampleTask3Name'] || "学习计划制定",
                    description: langMap['sampleTask3Desc'] || "制定下个月的个人学习计划",
                    dueDate: null,
                    createdAt: new Date().toISOString(),
                    completed: false
                }
            ];
            for (const task of sampleTasks) await addTaskToDB(task);
            tasks = await getAllTasks();
            renderTasks();
            showNotification(langMap['sampleTasksAdded']);
        }

        // --- 时间与状态计算工具 ---
        function calculateTimeLeft(utcStr) {
            const now = new Date();
            const due = utcToLocal(utcStr);
            return (due.getTime() - now.getTime()) / (1000 * 60); // 分钟
        }

        // 根据剩余时间获取状态
        function getStatus(minutesLeft) {
            const langMap = translations[currentLanguage];
            let status = {};
            // 关键分钟数：3天=4320, 7天=10080, 37天=53280
            if (minutesLeft < 0) {
                // --- 状态: 已过期 (Overdue) ---
                status = { statusClass: 'status-danger', text: langMap['statusOverdue'], progress: 100 }
            } else if (minutesLeft <= 4320) {
                // --- 状态: 危险 (Danger) --- (窗口: 0 - 3天 / 4320分钟)
                status = { statusClass: 'status-danger', text: langMap['statusDanger'],
                    // 进度: 从 3天(0%) 到 0天(100%)
                    progress: Math.min(100, ((4320 - minutesLeft) / 4320) * 100) };
            } else if (minutesLeft <= 10080) {
                // --- 状态: 警告 (Warning) --- (窗口: 3 - 7天 / 5760分钟)
                status = { statusClass: 'status-warning', text: langMap['statusWarning'],
                    // 进度: 从 7天(0%) 到 3天(100%)
                    progress: Math.min(100, ((10080 - minutesLeft) / 5760) * 100 ) };
            } else {
                // --- 状态: 安全 (Safe) --- (窗口: 7 - 37天 / 43200分钟)
                status = { statusClass: 'status-safe', text: langMap['statusSafe'],
                    progress: Math.min(100, Math.max(0, ((53280 - minutesLeft) / 43200) * 100)) };
            }
            return status;
        }
        // 本地时间 -> UTC ISO 字符串
        function localToUTC(dateStr, timeStr = '23:59') {
            const localDate = new Date(`${dateStr}T${timeStr}`);
            return new Date(localDate.getTime() + localDate.getTimezoneOffset() * 60000).toISOString();
        }

        // UTC ISO -> 本地 Date 对象
        function utcToLocal(utcStr) {
            const utcDate = new Date(utcStr);
            return new Date(utcDate.getTime() - utcDate.getTimezoneOffset() * 60000);
        }

        function formatTimeLeft(minutesLeft) {
            const langMap = translations[currentLanguage];
            if (minutesLeft < 0) {
                const minutesAgo = Math.abs(Math.floor(minutesLeft));
                if (minutesAgo < 60) return langMap['minutesAgo'].replace('{minutes}', minutesAgo.toString());
                if (minutesAgo < 1440) return langMap['hoursAgo'].replace('{hours}', Math.floor(minutesAgo / 60).toString());
                return langMap['daysAgo'].replace('{days}', Math.floor(minutesAgo / 1440).toString());
            }
            if (minutesLeft < 60) return langMap['minutesLeft'].replace('{minutes}', Math.floor(minutesLeft).toString());
            if (minutesLeft < 1440) {
                const h = Math.floor(minutesLeft / 60);
                const m = Math.floor(minutesLeft % 60);
                return m > 0 ? `${langMap['hoursLeft'].replace('{hours}', h.toString())} ${langMap['minutesLeft'].replace('{minutes}', m.toString())}`
                    : langMap['hoursLeft'].replace('{hours}', h.toString());
            }
            const d = Math.floor(minutesLeft / 1440);
            const h = Math.floor((minutesLeft % 1440) / 60);
            const m = Math.floor(minutesLeft % 60);
            if (d > 0 && h > 0 && m > 0) {
                return `${langMap['daysLeft'].replace('{days}', d.toString())} ${langMap['hoursLeft'].replace('{hours}', h.toString())}  ${langMap['minutesLeft'].replace('{minutes}', m.toString())}`
            } else if (d > 0 && h > 0) {
                return `${langMap['daysLeft'].replace('{days}', d.toString())} ${langMap['hoursLeft'].replace('{hours}', h.toString())}`
            } else if (d > 0 && m > 0) {
                return `${langMap['daysLeft'].replace('{days}', d.toString())} ${langMap['minutesLeft'].replace('{minutes}', m.toString())}`
            } else {
                return langMap['daysLeft'].replace('{days}', d.toString());
            }
        }

        // 缓存格式化器
        const dateTimeFormatters = {};

        function formatDateTime(utcStr) {
            const localDate = utcToLocal(utcStr);
            // 这里的 key 结合了语言，防止切换语言后格式没变
            const cacheKey = currentLanguage;

            if (!dateTimeFormatters[cacheKey]) {
                dateTimeFormatters[cacheKey] = new Intl.DateTimeFormat(
                    currentLanguage === 'zh-CN' ? 'zh-CN' : 'en-US',
                    { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }
                );
            }

            return dateTimeFormatters[cacheKey].format(localDate);
        }
        //
        // function formatDateTime(utcStr) {
        //     const localDate = utcToLocal(utcStr);
        //     const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
        //     return localDate.toLocaleDateString(currentLanguage === 'zh-CN' ? 'zh-CN' : 'en-US', options);
        // }

        // --- 导入 / 导出  ---
        function exportTasks() {
            const langMap = translations[currentLanguage];
            const data = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                storage: 'IndexedDB',
                tasks: tasks
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `tasks_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showNotification(langMap['exportSuccess']);
        }

        async function importTasks(file) {
            const langMap = translations[currentLanguage];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result.toString());

                    if (!importedData.tasks || !Array.isArray(importedData.tasks)) {
                        showNotification(langMap['importFormatError'], 'error');
                        return;
                    }

                    showConfirmModal(
                        langMap['import'],
                        langMap['importConfirm'].replace('{count}', importedData.tasks.length.toString()),
                        async () => {
                            // 导入 清除示例
                            await setConfig('sampleTasksAdded', true);

                            // 清空旧任务（确保等待完成）
                            await new Promise((resolve, reject) => {
                                const tx = db.transaction([STORE_NAME], 'readwrite');
                                const store = tx.objectStore(STORE_NAME);
                                const req = store.clear();
                                req.onsuccess = () => resolve();
                                req.onerror = (e) => reject(e);
                            });

                            for (const task of importedData.tasks) {
                                if (!task.id) task.id = Date.now() + Math.floor(Math.random() * 1000);
                                if (typeof task.completed !== 'boolean') task.completed = false;
                                if (!task.createdAt) task.createdAt = new Date().toISOString();
                                await addTaskToDB(task);
                            }

                            tasks = await getAllTasks();
                            renderTasks();

                            showNotification(langMap['importSuccess'].replace('{count}', importedData.tasks.length.toString()));
                        }
                    )

                } catch (error) {
                    showNotification(langMap['importReadError'], 'error');
                    console.error('导入错误:', error);
                }
            };
            reader.readAsText(file);
            importFileInput.value = ''; // 重置文件输入
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            // 1. 切换 DOM 属性（CSS 会自动响应）
            html.setAttribute('data-theme', newTheme);

            // 2. 保存到本地存储
            localStorage.setItem('theme', newTheme);
        }

    })(); // 结束 IIFE`
</script>
<script>
    // 注册 Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then((reg) => {
                    console.log('Service Worker 注册成功:', reg.scope);
                })
                .catch((err) => {
                    console.log('Service Worker 注册失败:', err);
                });
        });
    }
</script>
</body>
</html>